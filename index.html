<!DOCTYPE html>
<html>

<head>
    <title>ONNX Runtime JavaScript Example with Caching</title>
    <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin">
    <meta http-equiv="Cross-Origin-Embedder-Policy" content="require-corp">

    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/npyjs"></script>
    <script src="https://unpkg.com/wasm-feature-detect/dist/umd/index.js"></script>
</head>

<body>
    <button id="load">Load Model</button>
    <script>
        const modelUrls = {
            diffusion: './distilled_q.onnx',
            decoder: './decoder_q_gpu.onnx'
        };
        let diffusionSession, decoderSession;

        async function fetchAndCacheModel(url) {
            const cache = await caches.open('model-cache');
            const cachedResponse = await cache.match(url);

            if (cachedResponse) {
                console.log(`Loaded model from cache: ${url}`);
                return cachedResponse.arrayBuffer();
            } else {
                console.log(`Fetching model from network: ${url}`);
                const response = await fetch(url);
                cache.put(url, response.clone());  // Cache for future use
                return response.arrayBuffer();
            }
        }

        async function loadModel(url) {
            const modelBuffer = await fetchAndCacheModel(url);
            return new Uint8Array(modelBuffer);
        }

        async function initializeSessions() {
            const sessionOptions = {
                executionProviders: [
                    { name: 'webnn', deviceType: 'gpu', powerPreference: "high-performance" },
                    "wasm"
                ],
            };

            // Load diffusion and decoder models from cache/network
            const diffusionModelBuffer = await loadModel(modelUrls.diffusion);
            const decoderModelBuffer = await loadModel(modelUrls.decoder);

            // Initialize ONNX sessions with model buffers
            diffusionSession = await ort.InferenceSession.create(diffusionModelBuffer, sessionOptions);
            decoderSession = await ort.InferenceSession.create(decoderModelBuffer, sessionOptions);

            console.log("Models loaded and sessions initialized.");
        }

        document.querySelector('#load').addEventListener('click', async () => {
            await initializeSessions();
            console.log("Model sessions ready for inference.");
            // You can now run inference on these sessions as needed
        });
    </script>
</body>

</html>
